\documentclass[12pt, dvipsnames, a4paper]{article}
\usepackage{geometry}
\geometry{legalpaper, margin=0.5in}
\usepackage{xcolor}
\usepackage{lipsum,etoolbox}
\usepackage{xspace} 
\usepackage[normalem]{ulem}
\usepackage{vwcol}
\usepackage{cancel}
\usepackage{enumitem}
\usepackage{amsmath}
\usepackage{caption}
\usepackage{graphicx}
\usepackage{amsfonts}
\usepackage{float}
\usepackage{multicol}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{textcomp}
\usepackage{lstautogobble}
\usepackage[parfill]{parskip}
\usepackage{tikz-qtree}
\usepackage{tikz}
\usepackage{hyperref}
\usetikzlibrary{decorations.pathreplacing}
\tikzset{every tree node/.style={minimum width=4cm,draw,circle},
         blank/.style={draw=none},
         edge from parent/.style=
         {draw,edge from parent path={(\tikzparentnode) -- (\tikzchildnode)}},
         level distance=1.5cm}

%% Genearl %%
\renewcommand{\thesection}{\arabic{section}}


%% For convenience %%
\newcommand{\code}[1]{\texttt{#1}}
\newcommand{\bcode}[1]{\texttt{\textbf{#1}}}
\newcommand{\balert}[1]{\textbf{\alert{#1}}}
\newcommand{\rarrow}{$\Rightarrow$}
\newcommand{\tab}[1][0.5cm]{\hspace*{#1}}
\newcommand{\deepemphasis}[1]{\underline{\textbf{\Large{#1}}}}
\newcommand{\bfemph}[1]{\textbf{\emph{#1}}}
\newcommand{\OR}[0]{\lvert \: \rvert}

%% Colours %%
\definecolor{mLightBrown}{HTML}{EB811B}
\definecolor{mLightGreen}{HTML}{14B03D}

%% Pseudocode %% 
\lstdefinelanguage{pseudo}
{
	keywords=[1]{
		let,
		class,
		new,
		loop,
		until,
		end,
		if,
		else,
		then,
		return,
		while,
		for,
		to,
		fun,
		break,
		and,
		true,
		false,
		or,
		do,
		max,
		min,
		elif,
	},
	keywordstyle=[1]\color{black}\bf,
	keywords=[2] {
		invariant,
		precond,
		postcond
	},
	keywordstyle=[2]\color{blue}\bf
}

\lstset{
	breaklines		=	true,
	language 		= 	pseudo,
	basicstyle		=	\ttfamily,
	mathescape		=	true,
	escapeinside	=	||,
	tabsize			=	2,
	numbers			=	left,
	commentstyle	=	\color{OliveGreen},
	stringstyle		=	\color{mLightBrown},
	upquote			=	true,
	morestring		=	[b]',
	moredelim		=	[l][\rmfamily\itshape]{@},
	comment			=	[l]{//},
	morecomment		=	[s]{/*}{*/},
	commentstyle=\color{Gray}\ttfamily,
	showstringspaces=	false,
	showtabs		=	false,
	autogobble
}

%% Other %%
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}

% \patchcmd{<cmd>}{<search>}{<replace>}{<success>}{<failure>}
\patchcmd{\abstract}{\titlepage}{\titlepage% Insert ToC-writing after starting a titlepage
  \addcontentsline{toc}{chapter}{Abstract}}{}{}
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}

% Keywords command
\providecommand{\keywords}[1]
{
  \small	
  \textbf{\textit{Keywords---}} #1
}


%**************************************************************************************************************%
%______________________________________________________________________________________________________________%
\begin{document}
\title{\textbf{EECS 4314 - Bit Theory\\Architecture Enhancement Report}}
\date{\Large \today}
\author{
	\large \textbf{Amir Mohamad}\\ \small amohamad@my.yorku.ca\\\\
	\large \textbf{Arian Mohamad Hosaini}\\ \small mohama23@my.yorku.ca\\\\
	\large \textbf{Dante Laviolette}\\ \small dantelav@my.yorku.ca\\\\
	\large \textbf{Diego Santosuosso Salerno}\\ \small nicodemo@my.yorku.ca\\\\
	\large \textbf{Isaiah Linares}\\ \small isaiah88@my.yorku.ca\\\\
	\large \textbf{Joel Fagen}\\ \small joefagan@my.yorku.ca\\\\
	\large \textbf{Misato Shimizu}\\ \small misato1@my.yorku.ca\\\\
	\large \textbf{Muhammad Hassan}\\ \small furquanh@my.yorku.ca\\\\
	\large \textbf{Yi Qin}\\ \small aidenqin@my.yorku.ca\\\\
	\large \textbf{Zhilong Lin}\\ \small lzl1114@my.yorku.ca\\\\
	\large York University\\
}
\maketitle
\newpage
\hspace{0pt}
\vfill
\begin{abstract}
	\lipsum[1]
	\lipsum[1]
	\\\\
	\keywords{keyword1, keyword2, keyword3}
\end{abstract}
\vfill
\hspace{0pt}
\newpage
\tableofcontents
\clearpage

\section{Introduction}
\lipsum[1]

\subsection{Overview}
\lipsum[1]

\section{Architecture}
\subsection{Current State of The System}

In the current state of the system, the Linuxulator subsystem provides kernel
interfaces identical to Linux system calls to allow for emulation \cite{linuxbinarycompat}.
It does this by mapping Linux system calls to their FreeBSD equivalents \cite{linuxulator},
while also emulating parts of the Linux filesystem using \texttt{linsysfs} \cite{linsysfs}
Due to this, many Linux binaries can run natively on FreeBSD if the
\texttt{linux\_enable} flag is enabled in \texttt{/etc/rc.conf}.\\

Although, Linuxulator currently doesn't support \texttt{cgroups} or \texttt{namespaces}.
Due to this, any binaries that rely on these Linux features cannot run
natively on FreeBSD without modifications.\\

With that being said, it's important to note that FreeBSD has \texttt{jails},
which cover most of the use-cases of \texttt{cgroups} and \texttt{namespaces}.
A \texttt{jail} provides containerization, while \texttt{namespaces} and \texttt{cgroups}
can be used together to enable containerization.

\subsection{Enhanced State of The System}

Our proposal is to extend Linuxulator to provide interfaces for \texttt{namespaces}
and \texttt{cgroups}, while using \texttt{jails} internally.\\

More specifically, \texttt{namespaces} will be supported by supporting
the \texttt{set\_tid} argument in the \texttt{linux\_clone3} system call (\href{https://github.com/freebsd/freebsd-src/blob/953efa5b200f060564a090ab71b3d7f614a35e3f/sys/compat/linux/linux_fork.c#L398}{\texttt{sys/compat/linux/linux\_fork.c}})
which is currently ignored. Then when the \texttt{CLONE\_NEWPID} flag is passed in
\texttt{set\_tid}, a new jail will be created, which will enable
namespaces \cite{clone}. Internally, some logic will handle mapping the jail ID to the
returned PID, and simulate the cloned process seeing itself as PID 0.\\

The \texttt{cgroups} virtual file system will then be supported in the
Linuxulator file system (\texttt{linsysfs}), which will act as an interface
for modifying the \texttt{jails} resources.\\

With that being said, this will cause the Linuxulator to become dependent on
jails. Although, it will also greatly improve compatibility with linux
binaries, allowing applications such as Docker to run natively, while still
taking advantage of \texttt{jails}.

\section{Diagrams}
\lipsum[1]

\section{External Interfaces}
\lipsum[1]

\section{Use Cases}
\lipsum[1]


\section{Concurrency}
There are two different versions for how threads are handled in version 1 and 2. In version 1, threads are made distinct from processes. This way, one process can consist of multiple threads at a time. It is also possible to change the cgroups memberships of the threads within the process. However, that ability was removed in version 2, because it caused issues in some cases. For instance, all threads in a process shared a single address space, which caused issues for the memory controller, because it makes no sense to split threads across multiple memory cgroups. That ability was brought back in version 2’s thread mode.

In version 2, it has two restrictions imposed on it. One of them is no thread-granularity control, meaning that all threads of a process must belong to the same cgroup. Another restriction is no internal processes, meaning that a cgroup cannot have member processes while controlling child cgroups at the same time. In some cases, it makes sense to have thread-granularity control, such as the CPU controller, so that ability was brought back in the form of thread mode.

Thread mode has several abilities. One is the ability to create threaded subtrees where the threads of a given process are spread across multiple cgroups inside the tree. Another is a new feature called threaded controllers, which can distribute resources across the cgroups in a subtree. Also, the restriction for no internal processes is relaxed. Now, a cgroup can have its own threads and manage child cgroups at the same time. 

\section{Risks \& Limitations}
Although the proposed enhancement will lead to improving the overall operating system with better compatibility with Linux, it is still significant to examine how it would potentially affect other factors. For the section, we will observe the risks and limitations from three perspectives: Security, Maintainability, and Performance.

\subsection{Security}
One of the major concerns people would consider when they use containers is leaks of files and resources between the objects. Containers without complete separations would lead to poor efficiency for developments. However, it would not be a concern for this enhancement at this time because this proposed enhancement is based on existing functions and features. For example, to make \texttt{namespace}’s functions work correctly on FreeBSD, we utilize the existed \texttt{clone()} system call, which Linuxulator supports, instead of introducing a completely new idea into the system. Moreover, the mechanism of containers, which will be necessary for the namespace functionality, are from Jails. Jails is a virtual-machine-like containerization tool, completely separating users and processes from the space outside of a Jail \cite{jail}. Therefore, utilizing it as part of the enhancement’s functionalities would keep the system secure.

\subsection{Maintainability}
It might be an issue to maintain our proposed enhancement simply because of the relatively small population of contributors who actively support FreeBSD overall. As proof, only several-thousands of developers involve in FreeBSD development \cite{freebsd}. On the other hand, over 10,000 developers contribute in Linux more actively and frequently \cite{linux}. It is possible that the failure of implementation on native Docker development in the past is also due to this factor. Moreover, as there are already existing developed or developing implementations that can support Linux compatibility on FreeBSD, there might not be enough developers interested in or encouraged to maintain this new enhancement in the future. One of the existing implementations is runj, which follows the basics of runc for Linux \cite{runj}.

\subsection{Performance}
This aspect would be challenging to estimate as there is no existing case of internal usage of Jails. As explained earlier in this report, our idea of the enhancement is to create the same functionalities as unsupported Linux features, particularly \texttt{cgroups} and \texttt{namespaces}. Although the enhancement involves modifying the existing functions to add a new parameter feature and introducing fully built container system for isolations, it is still possible that the system will not work as it does by itself.

\section{Data Dictionary}
\begin{itemize}
	\item {Linuxulator (Linux Emulation): A technique to Linux binaries on FreeBSD without any modifications \cite{linuxulator}}
	\item {cgroups: One of the features in Linux, which sets aside resources within namespaces for other usages}
	\item {namespaces: One of the features in Linux, which creates several numbers of completely separated spaces within the operating system}
	\item {Docker: A technique based on both hypervisor-based and containerized virtualizations}
	\item {runj: A Docker-like tool which supports Jails based on the OCI runtime specifications}
	\item {runc: A Linux tool which manages container systems based on the OCI specifications}
	\item {Jails: A FreeBSD tool which follows the functionalities of the containerized virtualization}
\end{itemize}

\section{Naming Conventions}
\begin{itemize}
	\item {cgroup: Control group}
	\item {OCI: Open Container Initiative}
\end{itemize}

\section{Conclusion}
In conclusion, the proposed enhancement to extend the linuxulator subsystem in FreeBSD has the potential to significantly improve Linux binary compatibility on FreeBSD. Through a detailed analysis of the benefits, architectural impact, and use cases/sequence diagrams, the proposal demonstrates promising prospects for the FreeBSD operating system and its users. 

The enhancement allows for improved compatibility with Linux binaries, particularly for containerization platforms like Docker. This will provide FreeBSD users with access to a wider range of applications and a more seamless deployment and management experience.

The benefits of this enhancement are numerous. As mentioned throughout this report, it would improve compatibility with Linux binaries, enabling FreeBSD to support a wider range of applications and services. This increased compatibility would make FreeBSD more attractive to stakeholders, developers and users who rely on Linux-specific applications, potentially expanding the user base and fostering further development.

In addition, implementing cgroups and namespaces support would not only enhance resource management and process isolation within the operating system (which would consequently optimise performance, allocate resources more efficiently, and ensure better isolation between processes), but would also facilitate its integration with Docker. This would further broaden FreeBSD’s appeal and applicability in various use cases, from personal computing to large-scale data centres.

While there are some limitations and risks associated with this enhancement, such as the potential for leaks of files and resources between containers, with proper attention to security and maintainability, these risks can be mitigated. Additionally, the increased interest in the FreeBSD operating system that this enhancement may generate could result in additional contributions to the open-source community and further improvements to the operating system in the future.

In summary, extending the linuxulator subsystem in FreeBSD to provide interfaces for cgroups and namespaces using jails internally offers numerous benefits, including improved Linux binary compatibility, enhanced resource management and process isolation, and better integration with containerization technologies. However, it is essential to acknowledge the limitations and challenges associated with the proposed enhancement that will increase the overall system’s complexity. By carefully considering these factors and mitigating the identified challenges, the proposed enhancement has the potential to bring significant value to the FreeBSD operating system and its users.


\section{Lessons Learned}

\textbf{Importance of compatibility between operating systems:}  Enhancements that improve compatibility with other operating systems can significantly expand the range of applications and tools available to users, making an operating system more versatile and attractive. By ensuring compatibility, an operating system can also be used more easily in a variety of environments and integrated more easily with other systems.

\textbf{Different methods of containerization in Linux and FreeBSD:} As we analysed the FreeBSD Operating System to look for potential enhancement proposals, we learned about different methods of containerization technologies in both Linux and FreeBSD. Containerization is a popular technology used for deploying and managing applications. It was learnt that the methods used for containerization differ between Linux and FreeBSD, with jails being the preferred method in FreeBSD. Understanding these differences is important for making informed decisions about how to add support for features such as cgroups and namespaces.

\textbf{Security, maintainability, and performance are potential drawbacks of our proposal:} Enhancements that introduce new functionality or change the architecture of an operating system can also introduce potential risks and challenges by increasing it’s overall complexity. It is important to carefully consider the potential drawbacks of any proposed enhancement and develop strategies to mitigate risks related to security, maintainability, and performance. 

\textbf{Architectural analysis is crucial the implementation of such enhancement feature:} Enhancements that involve changes to an operating system's architecture require careful analysis to ensure that they are technically feasible, maintainable, and efficient. By performing a thorough analysis of the architecture and potential impacts of a proposed enhancement, stakeholders can make informed decisions about the potential implementation of features that could potentially add value to the overall system.

\textbf{Collaboration with stakeholders is crucial for successful enhancements:} Enhancements that involve significant changes to an operating system require collaboration with a range of stakeholders, including developers, users, and companies that may be impacted by the changes, such as Docker in this case. By engaging with stakeholders and soliciting feedback throughout the development process, it is possible to build enhancements that meet the needs of a wide range of users and maximise the benefits of the enhancement for all stakeholders involved.

\begin{thebibliography}{00}
	\bibitem{cgroups} Cgroups(7) - Linux Manual Page, \href{https://man7.org/linux/man-pages/man7/cgroups.7.html}{https://man7.org/linux/man-pages/man7/cgroups.7.html}. 
	\bibitem{linuxbinarycompat} “Chapter 11. Linux Binary Compatibility.” FreeBSD Documentation Portal, \href{https://docs.freebsd.org/en/books/handbook/linuxemu/}{https://docs.freebsd.org/en/books/handbook/linuxemu/}.	
	\bibitem{clone} Clone(2) - Linux Manual Page, \href{https://man7.org/linux/man-pages/man2/clone.2.html}{https://man7.org/linux/man-pages/man2/clone.2.html}.	
	\bibitem{jail} Delgado, Sergio  Carlavilla. “Chapter 16. Jails.” FreeBSD Documentation Portal, 4 Mar. 2023, \href{https://docs.freebsd.org/en/books/handbook/jails/}{https://docs.freebsd.org/en/books/handbook/jails/}.
	\bibitem{freebsd} Freebsd. “FreeBSD/FreeBSD-Src$\,\colon\,$ The Freebsd Src Tree.” GitHub, 1993, \href{https://github.com/freebsd/freebsd-src}{https://github.com/freebsd/freebsd-src}.
	\bibitem{linsysfs} “FreeBSD Manual Pages.” Linsysfs, \href{https://man.freebsd.org/cgi/man.cgi?linsysfs}{https://man.freebsd.org/cgi/man.cgi?linsysfs}.
	\bibitem{runj} Karp, Samuel. “Samuelkarp/Runj$\,\colon\,$ Runj.” GitHub, 2020, \href{https://github.com/samuelkarp/runj}{https://github.com/samuelkarp/runj}.	
	\bibitem{linuxulator} “Linuxulator.” Edited by Graham Perrin, Linuxulator - FreeBSD Wiki, 29 Jan. 2023, \href{https://wiki.freebsd.org/Linuxulator}{https://wiki.freebsd.org/Linuxulator}.
	\bibitem{linux} Torvalds, Linus. “Torvalds/Linux$\,\colon\,$ Linux Kernel Source Tree.” GitHub, 2002, \href{https://github.com/torvalds/linux}{https://github.com/torvalds/linux}. 



\end{thebibliography}
\end{document}
